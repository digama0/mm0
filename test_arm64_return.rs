#!/usr/bin/env rust-script
//! Test ARM64 with simple return instead of syscall

use std::fs::File;
use std::io::Write;
use std::os::unix::fs::PermissionsExt;

fn main() {
    // Simple ARM64 program that returns 42
    let code = vec![
        // mov w0, #42 (return value)
        0x40, 0x05, 0x80, 0x52,  // movz w0, #42
        
        // ret
        0xc0, 0x03, 0x5f, 0xd6,
    ];
    
    // Minimal Mach-O file for ARM64
    let mut output = Vec::new();
    
    // Mach-O header
    output.extend_from_slice(&[
        0xcf, 0xfa, 0xed, 0xfe,  // MH_MAGIC_64
        0x0c, 0x00, 0x00, 0x01,  // CPU_TYPE_ARM64
        0x00, 0x00, 0x00, 0x00,  // CPU_SUBTYPE_ARM64_ALL
        0x02, 0x00, 0x00, 0x00,  // MH_EXECUTE
        0x03, 0x00, 0x00, 0x00,  // ncmds = 3
        0xc8, 0x00, 0x00, 0x00,  // sizeofcmds
        0x85, 0x00, 0x20, 0x00,  // flags (MH_NOUNDEFS | MH_DYLDLINK | MH_TWOLEVEL | MH_PIE)
        0x00, 0x00, 0x00, 0x00,  // reserved
    ]);
    
    // LC_SEGMENT_64 __PAGEZERO
    output.extend_from_slice(&[
        0x19, 0x00, 0x00, 0x00,  // LC_SEGMENT_64
        0x48, 0x00, 0x00, 0x00,  // cmdsize = 72
    ]);
    output.extend_from_slice(b"__PAGEZERO\0\0\0\0\0\0");  // segname
    output.extend_from_slice(&[
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // vmaddr = 0
        0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,  // vmsize = 0x100000000
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // fileoff = 0
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // filesize = 0
        0x00, 0x00, 0x00, 0x00,  // maxprot = 0
        0x00, 0x00, 0x00, 0x00,  // initprot = 0
        0x00, 0x00, 0x00, 0x00,  // nsects = 0
        0x00, 0x00, 0x00, 0x00,  // flags = 0
    ]);
    
    // LC_SEGMENT_64 __TEXT
    output.extend_from_slice(&[
        0x19, 0x00, 0x00, 0x00,  // LC_SEGMENT_64
        0x48, 0x00, 0x00, 0x00,  // cmdsize = 72
    ]);
    output.extend_from_slice(b"__TEXT\0\0\0\0\0\0\0\0\0\0");  // segname
    output.extend_from_slice(&[
        0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00,  // vmaddr = 0x100000000
        0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // vmsize = 0x1000
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // fileoff = 0
        0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // filesize = 0x1000
        0x07, 0x00, 0x00, 0x00,  // maxprot = rwx
        0x05, 0x00, 0x00, 0x00,  // initprot = r-x
        0x00, 0x00, 0x00, 0x00,  // nsects = 0
        0x00, 0x00, 0x00, 0x00,  // flags = 0
    ]);
    
    // LC_MAIN
    output.extend_from_slice(&[
        0x28, 0x00, 0x00, 0x80,  // LC_MAIN
        0x18, 0x00, 0x00, 0x00,  // cmdsize = 24
        0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // entryoff = 0xf0
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  // stacksize = 0
    ]);
    
    // Pad to 0xf0 (where our code starts)
    while output.len() < 0xf0 {
        output.push(0);
    }
    
    // Add code
    output.extend_from_slice(&code);
    
    // Pad to page size
    while output.len() < 0x1000 {
        output.push(0);
    }
    
    // Write file
    let mut file = File::create("test_arm64_return42").unwrap();
    file.write_all(&output).unwrap();
    
    // Make executable
    let mut perms = file.metadata().unwrap().permissions();
    perms.set_mode(0o755);
    std::fs::set_permissions("test_arm64_return42", perms).unwrap();
    
    println!("Created test_arm64_return42");
    println!("Run: ./test_arm64_return42; echo $?");
    println!("Expected: 42");
}