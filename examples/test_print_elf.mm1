import "compiler.mm1";

do {
  (mmc-add '(
    (intrinsic @ proc (sys_write {fd : u32} {count : u32}
      (ghost @ mut {buf : (ref @ array u8 count)}) {p : (&sn buf)} : u32))
    
    (intrinsic @ proc (sys_exit {code : u8} :))

    (proc (main {n : u32})
      -- Convert n to a printable digit (n % 10) + '0'
      {{digit : u8} := (cast {48 + {n % 10}})}
      {{buf : (array u8 2)} := (list digit 10)}  -- digit + newline
      {_ := (sys_write 1 2 buf (& buf))}
      -- Exit with the value passed as argument (modulo 256)
      (sys_exit (cast n))
      )
  ))
  
  -- Generate the ELF string and write to a file
  (def elf (mmc->string))
  -- We'll need to output this manually since output string doesn't work with lisp defs
};

-- This will fail but that's ok, we got the ELF bytes printed above