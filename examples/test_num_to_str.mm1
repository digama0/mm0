import "compiler.mm1";

do {
  (mmc-add '(
    (intrinsic @ proc (sys_write {fd : u32} {count : u32}
      (ghost @ mut {buf : (ref @ array u8 count)}) {p : (&sn buf)} : u32))

    -- Simple procedure to convert a single digit to ASCII
    (proc (digit_to_ascii {d : u32} : u8)
      {{c : u8} := (cast {d + 48})}  -- '0' = 48 in ASCII
      c)
    
    -- Convert a 2-digit number to string (hardcoded for now)
    (proc (two_digit_to_str {n : u32} {buf : (&sn (array u8 2))})
      {{tens : u32} := (cast {n / 10})}    -- Get tens digit
      {{ones : u32} := (cast {n % 10})}    -- Get ones digit
      
      {{c1 : u8} := (digit_to_ascii tens)}
      {{c2 : u8} := (digit_to_ascii ones)}
      
      (buf <- c1)
      ((& buf[1]) <- c2)
    )

    (proc (main {n : u32})
      -- Test with hardcoded 123
      {{a : u32} := n}
      {{b : u32} := 77}
      {{sum : u32} := (cast {a + b})}  -- 200
      
      -- For now, just show we can call functions
      {{d : u8} := (digit_to_ascii 5)}  -- Should be '5' (53)
      
      -- Display test message
      {{msg : (array u8 24)} := (list . ,(string->list "Function calls work!\n"))}
      {_ := (sys_write 1 21 msg (& msg))}
      )
  ))
  
  -- Generate the ELF
  (print (mmc->string))
};